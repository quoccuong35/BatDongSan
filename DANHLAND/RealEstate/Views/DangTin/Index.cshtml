@{
    ViewBag.Title = Resources.App.DangTin_DanhSach;
    Layout = "~/Views/Shared/_Layout.cshtml";
}
@{
    bool menu = false;
    bool xemtin = false;
    bool edit = false;
    if (User.IsInRole("29=1") || User.IsInRole("0=0"))
    {
        xemtin = true;
    }

    if (User.IsInRole("30=1") || User.IsInRole("0=0"))
    {
        edit = true;
    }

    if (xemtin || edit)
    {
        menu = true;
    }
}
@section Header{
    <div class="d-flex align-items-center flex-wrap mr-1">
        <button class="btn btn-icon mr-4" id="kt_aside_toggle">
            <span class="svg-icon svg-icon-xl">
                <svg xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" width="24px" height="24px" viewBox="0 0 24 24" version="1.1">
                    <g stroke="none" stroke-width="1" fill="none" fill-rule="evenodd">
                        <rect x="0" y="0" width="24" height="24" />
                        <path d="M2 11.5C2 12.3284 2.67157 13 3.5 13H20.5C21.3284 13 22 12.3284 22 11.5V11.5C22 10.6716 21.3284 10 20.5 10H3.5C2.67157 10 2 10.6716 2 11.5V11.5Z" fill="black" />
                        <path opacity="0.5" fill-rule="evenodd" clip-rule="evenodd" d="M9.5 20C8.67157 20 8 19.3284 8 18.5C8 17.6716 8.67157 17 9.5 17H20.5C21.3284 17 22 17.6716 22 18.5C22 19.3284 21.3284 20 20.5 20H9.5ZM15.5 6C14.6716 6 14 5.32843 14 4.5C14 3.67157 14.6716 3 15.5 3H20.5C21.3284 3 22 3.67157 22 4.5C22 5.32843 21.3284 6 20.5 6H15.5Z" fill="black" />
                    </g>
                </svg>
            </span>
        </button>
        <div class="d-flex align-items-baseline flex-wrap mr-5">
            <div class="input-group-append  mr-2 btn-light-primary font-weight-boldere">
                <select class="form-control selectpicker tien-bg2" id="loai-tin">
                    <option selected value="1">Danh sách tin đang hiển thị</option>
                    <option value="2">Danh sách tin đang bị ẩn</option>
                </select>

            </div>
            <ul class="breadcrumb breadcrumb-transparent breadcrumb-dot font-weight-bold p-0 my-2 ">
                <li class="breadcrumb-item text-muted">
                    <a href="javascript:;" class="text-muted">@Resources.App.DangTin</a>
                </li>
                <li class="breadcrumb-item text-muted">
                    <a href="@Url.Action("Index","DangTin")" class="text-muted"> @Resources.App.DangTin_QuanLy</a>
                </li>
            </ul>
        </div>
    </div>
    <div class="d-flex align-items-center">
        @if (User.IsInRole("0=0") || User.IsInRole("32=1"))
        {
            <a href="javascript: void(0);" class="btn  btn-light-success hide font-weight-bolder mr-2" id="btn_restore">
                <i class="flaticon2-reply-1"></i> <span id="text-restore"></span>
            </a>
        }
        @if (User.IsInRole("0=0") || User.IsInRole("31=1"))
        {
            <a href="javascript: void(0);" class="btn  btn-light-warning hide font-weight-bolder mr-2" id="btn_hiden">
                <i class="flaticon-medical"></i> <span id="text-antin"></span>
            </a>
        }
        @if (User.IsInRole("0=0") || User.IsInRole("33=1"))
        {
            <a href="javascript: void(0);" class="btn  btn-light-danger hide font-weight-bolder mr-2" id="btn_delete">
                <i class="flaticon-delete"></i> <span id="text-delete"></span>
            </a>
        }
        @if (User.IsInRole("0=0") || User.IsInRole("28=1"))
        {
            <a href="@Url.Action("Create","DangTin")" class="btn btn-primary font-weight-bolder">
                <span class="svg-icon svg-icon-md">
                    <svg xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" width="24px" height="24px" viewBox="0 0 24 24" version="1.1">
                        <g stroke="none" stroke-width="1" fill="none" fill-rule="evenodd">
                            <rect x="0" y="0" width="24" height="24"></rect>
                            <circle fill="#000000" cx="9" cy="15" r="6"></circle>
                            <path d="M8.8012943,7.00241953 C9.83837775,5.20768121 11.7781543,4 14,4 C17.3137085,4 20,6.6862915 20,10 C20,12.2218457 18.7923188,14.1616223 16.9975805,15.1987057 C16.9991904,15.1326658 17,15.0664274 17,15 C17,10.581722 13.418278,7 9,7 C8.93357256,7 8.86733422,7.00080962 8.8012943,7.00241953 Z" fill="#000000" opacity="0.3"></path>
                        </g>
                    </svg>
                </span> @Resources.App.DangTin_TinMoi
            </a>
        }

    </div>
}
<div class="row">

    <div class="col-lg-12">
        <div id="list_danh_sach"></div>
    </div>
</div>

@section CustomScripts{
<script type="text/javascript">
        var dataDuAn =@Html.Raw(RealEstate.Libs.ThongTin.GetDanhMucString("du-an")),
            dataLoaiCanHo =@Html.Raw(RealEstate.Libs.ThongTin.GetDanhMucString("loai")),
            dataLoaiKinhDoanh =@Html.Raw(RealEstate.Libs.ThongTin.GetDanhMucString("loai-kinh-doanh")),
            dataHuongCua =@Html.Raw(RealEstate.Libs.ThongTin.GetDanhMucString("huong")),
            dataViews =@Html.Raw(RealEstate.Libs.ThongTin.GetDanhMucString("views"));
            dataViTri =@Html.Raw(RealEstate.Libs.ThongTin.GetDanhMucString("vi-tri"));
        $(function () {
            var wh = $(window).height();
            $('#list_danh_sach').height(wh - 180);
            $('#loai-tin').change(function () {
                $('#btn_hiden,#btn_delete,#btn_restore').addClass('hide');
                loadTin();
            });
            loadTin();
        });
        function loadTin() {
            $.get("@Url.Action("getDataDangTin","DangTin")", { LoaiTin: $('#loai-tin').val() }).done(function (rs) {
                $("#list_danh_sach").dxDataGrid({
                    dataSource: rs,
                    showRowLines: true,
                    rowAlternationEnabled: true,
                    showBorders: true,
                    hoverStateEnabled: true,
                    allowColumnReordering: true,
                    allowColumnResizing: true,
                    columnAutoWidth: true,
                    keyExpr: "id",
                    filterRow: {
                        visible: true,
                        applyFilter: "auto"
                    },
                    paging: {
                        pageSize: 10
                    },
                    pager: {
                        showPageSizeSelector: true,
                        allowedPageSizes: [10, 15, 20, 50, 100],
                        showInfo: true
                    },
                    selection: {
                        mode: "multiple"
                    },
                    onContentReady: function (e) {
                        e.component.clearSelection();
                        $('#btn_hiden,#btn_delete,#btn_restore').addClass('hide');
                    },
                    columns: [
                        {
                            caption: 'Tác vụ', dataField: "id", fixed: true, fixedPosition: "left", alignment: 'center', editCellTemplate: function (cellElement, cellInfo) {
                                var data = cellInfo.data;
                                $('<div>').appendTo(cellElement).dxMenu({
                                    items: [{
                                        icon: 'flaticon2-gear text-primary',
                                        items: [{
                                            icon: "flaticon-eye text-success",
                                            text: 'Xem tin đăng',
                                            visible:"@xemtin" == "True" ? true : false,
                                        }, {
                                            icon: 'text-primary flaticon-edit-1',
                                                text: 'Chỉnh sửa',
                                            visible:"@edit" == "True" ? true : false,
                                        }]
                                    }], itemTemplate: function (itemData, itemIndex, itemElement) {
                                        if (itemData.text) {
                                            if (itemIndex == 0 && "@xemtin" == "True") {

                                                itemElement.append('<a class="mt-6 p-3" target="_blank" href="@ViewBag.site_url?post_type=estate&p=' + data.id + '"><span class="navi-icon mr-2"><i class="' + itemData.icon + '"></i></span><span class="font-weight-bold font-size-h5 text-dark-75 text-hover-primary">' + itemData.text + '</span></a>');
                                            }
                                            else if (itemIndex == 1 && "@User.IsInRole("7=1")" == "True") {

                                                itemElement.append('<a class="mt-6 p-3" href="@Url.Action("Edit", "DangTin")?id=' + data.id + '"><span class="navi-icon mr-2"><i class="' + itemData.icon + '"></i></span><span class="font-weight-bold font-size-h5 text-dark-75 text-hover-primary">' + itemData.text + '</span></a>');
                                            }
                                        } else {
                                            itemElement.append('<span class="svg-icon svg-icon-xl svg-icon-primary"><svg xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" width="24px" height="24px" viewBox="0 0 24 24" version="1.1"><g stroke="none" stroke-width="1" fill="none" fill-rule="evenodd">    <rect x="0" y="0" width="24" height="24"></rect>    <path d="M5,8.6862915 L5,5 L8.6862915,5 L11.5857864,2.10050506 L14.4852814,5 L19,5 L19,9.51471863 L21.4852814,12 L19,14.4852814 L19,19 L14.4852814,19 L11.5857864,21.8994949 L8.6862915,19 L5,19 L5,15.3137085 L1.6862915,12 L5,8.6862915 Z M12,15 C13.6568542,15 15,13.6568542 15,12 C15,10.3431458 13.6568542,9 12,9 C10.3431458,9 9,10.3431458 9,12 C9,13.6568542 10.3431458,15 12,15 Z" fill="#000000"></path></g></svg></span>');
                                        }
                                    },
                                    showFirstSubmenuMode: 'onclicke',
                                    hideSubmenuOnMouseLeave: true,
                                    //onItemClick: function (e) {

                                    //    Menu(e, cellInfo.key);
                                    //},
                                });
                            }, showEditorAlways: true,

                            width: 70,
                            visible:"@menu" == "True" ? true : false,
                        },
                        {
                        dataField: "post_title",
                        caption: "TIÊU ĐỀ",
                        allowEditing: false, fixed: true,
                        cellTemplate: function (container, options) {
                            var data = options.data;
                            container.html('<div class="d-flex align-items-center"><div class="symbol symbol-40 symbol-light-danger flex-shrink-0"><img class="" src="' + data.hinh_dai_dien + '" alt="photo"></div><div class="ml-4">	<div class="text-dark-75 font-weight-bolder font-size-lg mb-0">' + data.post_title + '</div>	<span class="text-muted font-weight-bold text-hover-primary">' + (data.dia_chi ? data.dia_chi : '') + '</span></div>							</div>');
                        }
                    },

                    {
                        dataField: "du_an",
                        caption: "DỰ ÁN",
                        lookup: {
                            dataSource: dataDuAn,
                            valueExpr: "term_taxonomy_id",
                            displayExpr: "name",
                        }
                    },
                    {
                        dataField: "loai",
                        caption: "LOẠI CĂN HỘ",
                        lookup: {
                            dataSource: dataLoaiCanHo,
                            valueExpr: "term_taxonomy_id",
                            displayExpr: "name",
                        }
                    },
                    {
                        dataField: "loai_kinh_doanh",
                        caption: "LOẠI KINH DOANH",
                        cellTemplate: function (container, options) {
                            var data = options.data;
                            if (data.loai_kinh_doanh) {
                                var txt = [];
                                var arr = data.loai_kinh_doanh.split(',');
                                $.each(dataLoaiKinhDoanh, function (i, item) {
                                    if (arr.length > 0)
                                        for (var i = 0; i < arr.length; i++)
                                            if (item.term_taxonomy_id == arr[i]) {
                                                txt.push(item.name);
                                            }
                                });
                                container.html(txt.join('; '));
                            } else {
                                container.html('');
                            }
                        }
                    },
                    {
                        dataField: "phong_ngu",
                        caption: "PN",
                        width: 100,
                        allowEditing: false
                    },
                    {
                        dataField: "wc",
                        caption: "WC",
                        allowEditing: false
                    },
                    {
                        dataField: "dien_tich",
                        caption: "DT",
                        allowEditing: false
                    },
                    {
                        dataField: "views",
                        caption: "Views",
                        lookup: {
                            dataSource: dataViews,
                            valueExpr: "term_taxonomy_id",
                            displayExpr: "name",
                        }
                    },
                    {
                        dataField: "vi_tri",
                        caption: "Vi trí",
                        lookup: {
                            dataSource: dataViTri,
                            valueExpr: "term_taxonomy_id",
                            displayExpr: "name",
                        }
                    },
                    {
                        dataField: "huong",
                        caption: "HƯỚNG CỬA",
                        lookup: {
                            dataSource: dataHuongCua,
                            valueExpr: "term_taxonomy_id",
                            displayExpr: "name",
                        }
                    },
                        {
                            dataField: "gia_ban",
                            caption: "GIÁ BÁN",
                            width: 100,
                            allowEditing: false
                        },
                        {
                            dataField: "gia_thue",
                            caption: "GIÁ THUÊ",
                            width: 100,
                            allowEditing: false
                        },
                        {
                            dataField: 'post_date',
                            caption: 'NGÀY ĐĂNG',
                            dataType: 'datetime', format: 'dd/MM/yyyy HH:mm a'
                        }, {
                            dataField: 'author',
                            caption: 'NGƯỜI ĐĂNG',

                        },
                    
                    ],
                    onEditorPreparing: function (e) {
                        if (e.parentType == "filterRow" && e.editorName == 'dxSelectBox')
                            e.editorOptions.onOpened = function (e) { e.component._popup.option('width', 250); };
                    },
                    onSelectionChanged: function (selectedItems) {
                        var data = selectedItems.selectedRowsData;
                        if (data.length > 0) {
                            if ($('#loai-tin').val() == 1) {
                                $('#btn_restore,btn_delete').addClass('hide');
                                $('#btn_hiden').removeClass('hide');
                            } else {
                                $('#btn_hiden').addClass('hide');
                                $('#btn_restore,#btn_delete').removeClass('hide');

                            }
                            $('#text-antin').text('Ẩn ' + data.length + ' tin đã chọn');
                            $('#text-delete').text('Xóa ' + data.length + ' tin đã chọn');
                            $('#text-restore').text('Khôi phục ' + data.length + ' tin đã chọn');
                        }
                        else {
                            $('#btn_hiden,#btn_delete,#btn_restore').addClass('hide');
                        }

                    }
                    //onCellPrepared: function (e) {
                    //    if (e.rowType === "data" && (e.column.dataField === "post_status")) {
                    //        var value = e.value;
                    //        if (value =='publish') {
                    //            e.cellElement.css({ "background-color": "#c6efce", 'color': '#2c6100' });
                    //        } else {
                    //            e.cellElement.css({ "background-color": "#ffc7ce" });
                    //        }
                    //    }
                    //}
                });
            });
        }
</script>
    <script type="text/javascript">
        $(document).ready(function () {
            $('#btn_hiden').click(function () {
                var tindang = [];
                $.each($("#list_danh_sach").dxDataGrid('instance').getSelectedRowsData(), function () {
                    tindang.push(this.id);
                });
                if (tindang.length > 0) {
                    Swal.fire({
                        title: "Cảnh báo?",
                        html: '<b class="text-danger">Bạn có chắc ẩn ' + tindang.length + ' đã chọn không không?</b><br />Khách hàng sẽ không thấy được những tin ẩn này!',
                        icon: "warning",
                        showCancelButton: true,
                        confirmButtonText: "Có, ẩn ngay!",
                        cancelButtonText: "Hủy!",
                        reverseButtons: true
                    }).then(function (result) {
                        if (result.value) {
                            KTApp.blockPage({ overlayColor: '#000000', state: 'primary', message: 'Đang ẩn tin...' });
                            $.post('@Url.Action("AnTinDang", "DangTin")', { id: tindang.join(), __RequestVerificationToken: $('input[name="__RequestVerificationToken"]').val() }).done(function (rs) {
                                KTApp.unblockPage();
                                if (rs.rs_code == 1) {
                                    loadTin();

                                    ShowToast.success('Ẩn tin đăng thành công', 3000);
                                } else {
                                    Swal.fire("Có lỗi!", rs.rs_text, "error");

                                }
                            }).fail(function () {
                                KTApp.unblockPage();
                                ShowToast.warning('Có lỗi xảy ra', 3000);
                            });
                        } else if (result.dismiss === "cancel") {
                            ShowToast.info('Bạn đã hủy ẩn tin', 3000);

                        }
                    });
                }
            });
        });
    </script>
    <script type="text/javascript">
        $(document).ready(function () {
            $('#btn_restore').click(function () {
                var tindang = [];
                $.each($("#list_danh_sach").dxDataGrid('instance').getSelectedRowsData(), function () {
                    tindang.push(this.id);
                });
                if (tindang.length > 0) {
                    Swal.fire({
                        title: "Cảnh báo?",
                        html: '<b class="text-success">Bạn có chắc khôi phục ' + tindang.length+' đã chọn không không?</b>',
                        icon: "warning",
                        showCancelButton: true,
                        confirmButtonText: "Có, khôi phục!",
                        cancelButtonText: "Hủy!",
                        reverseButtons: true
                    }).then(function (result) {
                        if (result.value) {
                            KTApp.blockPage({ overlayColor: '#000000', state: 'primary', message: 'Đang khôi phục tin...' });
                            $.post('@Url.Action("KhoiPhucTinDang", "DangTin")', { id: tindang.join(), __RequestVerificationToken : $('input[name="__RequestVerificationToken"]').val()}).done(function (rs) {
                        KTApp.unblockPage();
                        if (rs.rs_code == 1) {
                            loadTin();

                            ShowToast.success('Khôi phục tin đăng thành công', 3000);
                        } else {
                            Swal.fire("Có lỗi!", rs.rs_text, "error");

                        }
                    }).fail(function () {
                        KTApp.unblockPage();
                        ShowToast.warning('Có lỗi xảy ra', 3000);
                    });
                        } else if (result.dismiss === "cancel") {
                            ShowToast.info('Bạn đã hủy khôi phục tin', 3000);

                        }
                    });
                }
            });
        });
    </script>
    <script type="text/javascript">
        $(document).ready(function () {
            $('#btn_delete').click(function () {
                var tindang = [];
                $.each($("#list_danh_sach").dxDataGrid('instance').getSelectedRowsData(), function () {
                    tindang.push(this.id);
                });
                if (tindang.length > 0) {
                    Swal.fire({
                        title: "Cảnh báo?",
                        html: '<b class="text-danger">Bạn có chắc xóa ' + tindang.length + ' này không?</b><br />Dữ liệu đã xóa thì không thể khôi phục được!',
                        icon: "warning",
                        showCancelButton: true,
                        confirmButtonText: "Có, xóa ngay!",
                        cancelButtonText: "Hủy!",
                        reverseButtons: true
                    }).then(function (result) {
                        if (result.value) {
                              KTApp.blockPage({ overlayColor: '#000000', state: 'primary', message: 'Đang xóa tin...' });
                            $.post('@Url.Action("XoaTinDang", "DangTin")', { id: tindang.join(), __RequestVerificationToken: $('input[name="__RequestVerificationToken"]').val() }).done(function (rs) {
                                KTApp.unblockPage();
                                if (rs.rs_code == 1) {
                                    loadTin();
                                    ShowToast.success('Xóa tin đăng thành công', 3000);
                                } else {
                                    Swal.fire("Có lỗi!", rs.rs_text, "error");
                                }
                            }).fail(function () {
                                KTApp.unblockPage();
                                ShowToast.warning('Có lỗi xảy ra', 3000);
                            });
                        } else if (result.dismiss === "cancel") {
                            ShowToast.info('Bạn đã hủy xóa tin đăng bổ sung', 3000);

                        }
                    });
                }
            });
        });
    </script>
}
