
@{
    ViewBag.Title = Resources.App.DangTin_TinMoi;
    Layout = "~/Views/Shared/_Layout.cshtml";
    string imgs_key = System.Guid.NewGuid().ToString();
}
@section CSSFileTop{
    <link href="~/Content/css/uppy.bundle.css" rel="stylesheet" />
}
@section Header{

    <div class="d-flex align-items-center flex-wrap mr-1">

        <button class="btn btn-icon mr-4" id="kt_aside_toggle">
            <span class="svg-icon svg-icon-xl">

                <svg xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" width="24px" height="24px" viewBox="0 0 24 24" version="1.1">
                    <g stroke="none" stroke-width="1" fill="none" fill-rule="evenodd">
                        <rect x="0" y="0" width="24" height="24" />
                        <path d="M2 11.5C2 12.3284 2.67157 13 3.5 13H20.5C21.3284 13 22 12.3284 22 11.5V11.5C22 10.6716 21.3284 10 20.5 10H3.5C2.67157 10 2 10.6716 2 11.5V11.5Z" fill="black" />
                        <path opacity="0.5" fill-rule="evenodd" clip-rule="evenodd" d="M9.5 20C8.67157 20 8 19.3284 8 18.5C8 17.6716 8.67157 17 9.5 17H20.5C21.3284 17 22 17.6716 22 18.5C22 19.3284 21.3284 20 20.5 20H9.5ZM15.5 6C14.6716 6 14 5.32843 14 4.5C14 3.67157 14.6716 3 15.5 3H20.5C21.3284 3 22 3.67157 22 4.5C22 5.32843 21.3284 6 20.5 6H15.5Z" fill="black" />
                    </g>
                </svg>

            </span>
        </button>

        <div class="d-flex align-items-baseline flex-wrap mr-5">

            <h5 class="text-dark font-weight-bold my-1 mr-5">
                @Resources.App.DangTin_TinMoi

            </h5>
            <ul class="breadcrumb breadcrumb-transparent breadcrumb-dot font-weight-bold p-0 my-2 ">
                <li class="breadcrumb-item text-muted">
                    <a href="" class="text-muted">@Resources.App.DangTin</a>
                </li>
                <li class="breadcrumb-item text-muted">
                    <a href="" class="text-muted"> @Resources.App.DangTin_QuanLy</a>
                </li>

            </ul>
        </div>
    </div>

    <div class="d-flex align-items-center">
        <a href="@Url.Action("Index","DangTin")" class="btn btn-default font-weight-bold  px-3 font-size-base  mr-2">  @Resources.App.QuayLai</a>
        <div class="btn-group ml-2">
            <button type="button" class="btn btn-primary font-weight-bold btn-sm px-3 font-size-base" id="btn-save">
                <i class="la la-save"></i>      @Resources.App.CapNhat
            </button>
    
        </div>


    </div>

}

<div class="card card-custom">
    <div class="card-header">

        <div class="card-toolbar">
            <ul class="nav nav-light-danger nav-bold nav-pills">
                <li class="nav-item ">
                    <a class="nav-link active" data-toggle="tab" href="#tab_hoso">
                        <span class="nav-icon">
                            <i class="flaticon-layer"></i>
                        </span>
                        <span class="nav-text">Thông tin chính</span>
                    </a>
                </li>
                <li class="nav-item">
                    <a class="nav-link" data-toggle="tab" href="#tab_hinhanh">
                        <span class="nav-icon">
                            <i class="flaticon2-image-file"></i>
                        </span>
                        <span class="nav-text">Hình ảnh</span>
                    </a>
                </li>
                <li class="nav-item ">
                    <a class="nav-link" data-toggle="tab" href="#tab_diachi">
                        <span class="nav-icon">
                            <i class="flaticon-placeholder-3"></i>
                        </span>
                        <span class="nav-text">Địa chỉ</span>
                    </a>
                </li>

                @*<li class="nav-item">
            <a class="nav-link" data-toggle="tab" href="#tab_dinhkem">
                <span class="nav-icon">
                    <i class="flaticon-attachment"></i>
                </span>
                <span class="nav-text">Đính kèm</span>
            </a>
        </li>*@
                <li class="nav-item">
                    <a class="nav-link" data-toggle="tab" href="#tab_bosung">
                        <span class="nav-icon">
                            <i class="flaticon-interface-9"></i>
                        </span>
                        <span class="nav-text">Tính năng bổ sung</span>
                    </a>
                </li>
            </ul>
        </div>
    </div>
    <div class="card-body">
        <div class="tab-content">
            <div class="tab-pane fade  active show" id="tab_hoso" role="tabpanel" aria-labelledby="tab_hoso">
                <form id="inputform" class="form" data-parsley-validate>
                    <div class="form-group row">
                        <div class="col-lg-5">
                            <label class="form-label">Tiêu đề đăng tin <b class="text-danger">*</b></label>
                            <input type="text" class="form-control form-control-solid" id="txt-title" placeholder="Tiêu đề đăng tin" required name="txt_title">
                        </div>
                        <div class="col-lg-3">
                            <label class="form-label">Dự án <b class="text-danger">*</b></label>
                            <div id="select-duan">
                            </div>
                        </div>  <div class="col-lg-4">
                            <label class="form-label">Chủ đầu tư <b class="text-danger">*</b></label>
                            <div id="select-chudautu">
                            </div>
                        </div>
                    </div>
                    <div class="separator separator-dashed my-5"></div>
                    <div class="form-group row">

                        <div class="col-lg-2">
                            <label class="form-label">Diện tích </label>
                            <div id="txt-dientich">
                            </div>
                        </div>
                        <div class="col-lg-2">
                            <label class="form-label">Hướng cửa</label>
                            <div id="select-huongcua">
                            </div>
                        </div>
                        <div class="col-lg-2">
                            <label class="form-label">Số PN</label>
                            <div id="txt-sophongngu">
                            </div>
                        </div>
                        <div class="col-lg-2">
                            <label class="form-label">Số WC</label>
                            <div id="txt-sowc">
                            </div>
                        </div>
                        <div class="col-lg-4">
                            <label class="form-label">View</label>
                            <div id="select-views">
                            </div>
                        </div>
                    </div>

                    <div class="form-group row">

                        <div class="col-lg-2">
                            <label class="form-label">Tình trạng <b class="text-danger">*</b></label>
                            <div id="select-tinhtrangcanho">
                            </div>
                        </div>
                        <div class="col-lg-2">
                            <label class="form-label">Loại căn hộ <b class="text-danger">*</b></label>
                            <div id="select-loaicanho">
                            </div>
                        </div>
                        <div class="col-lg-2">
                            <label class="form-label">Vị trí<b class="text-danger">*</b></label>
                            <div id="select-vitri">
                            </div>
                        </div>
                        <div class="col-lg-2">
                            <label class="form-label">Loại bàn giao</label>
                            <div id="select-loaibangiao">
                            </div>
                        </div>
                        <div class="col-lg-4">
                            <label class="form-label">Video Link</label>
                            <input type="text" id="txt-videolink" class="form-control" placeholder="Nhập video link">

                        </div>
                    </div>
                    <div class="separator separator-dashed my-5"></div>
                    <div class="form-group row">
                        <div class="col-lg-4">
                            <label class="form-label">Loại kinh doanh <b class="text-danger">*</b></label>
                            <div id="select-loaikinhdoanh">

                            </div>
                        </div>
                        <div class="col-lg-2">
                            <label class="form-label">Giá bán (VNĐ)<span class="text-danger text-cost" id="text-giaban"></span></label>

                            <div class="input-group input-group-solid">
                                <div id="txt-giaban" class="form-control">
                                </div>
                                <div class="input-group-append ">
                                    <select class="form-control selectpicker tien-bg" id="tien-ban">
                                        <option selected value="ty">Tỷ</option>
                                        <option value="trieu">Triệu</option>

                                    </select>

                                </div>
                            </div>

                        </div>

                        <div class="col-lg-2 ">
                            <label class="form-label">Giá bán (USD)<span class="text-danger text-cost" id="text-giabanusd"></span></label>
                            <div id="txt-giabanusd">
                            </div>
                        </div>

                        <div class="col-lg-2">
                            <label class="form-label">Giá thuê (VNĐ)<span class="text-danger text-cost" id="text-giathue"></span></label>

                            <div class="input-group input-group-solid">
                                <div id="txt-giathue" class="form-control">
                                </div>
                                <div class="input-group-append ">
                                    <select class="form-control selectpicker tien-bg" id="tien-thue">
                                        <option selected value="ty">Tỷ</option>
                                        <option value="trieu">Triệu</option>
                                    </select>

                                </div>
                            </div>
                        </div>

                        <div class="col-lg-2">
                            <label class="form-label">Giá thuê  (USD) <span class="text-danger text-cost" id="text-giathueusd"></span></label>
                            <div id="txt-giathueusd">
                            </div>
                        </div>

                    </div>
                    <div class="separator separator-dashed my-5"></div>

                    <div class="row">
                        <div class="col-lg-12">
                            <div id="txt_noidung-toolbar"></div>
                            <div id="txt_noidung" class="ck-blurred ck ck-content ck-editor__editable ck-rounded-corners ck-editor__editable_inline cus-border" lang="en" dir="ltr" role="textbox" aria-label="Rich Text Editor, main" contenteditable="true"></div>
                        </div>
                    </div>

                </form>
            </div>
            <div class="tab-pane fade" id="tab_diachi" role="tabpanel" aria-labelledby="tab_diachi">
                <div class="row">
                    <div class="col-sm-8">
                        <label class="form-label">Địa chỉ</label>
                        <input type="text" id="txt-diachi" class="form-control" placeholder="Nhập địa chỉ">
                    </div>
                    <div class="col-sm-2">
                        <label class="form-label">Kinh độ</label>
                       <div id="txt-lat"></div>
                    </div>
                    <div class="col-sm-2">
                        <label class="form-label">Vĩ độ</label>
                        <div id="txt-lng"></div>
                    </div>
                </div>
            </div>
            <div class="tab-pane fade" id="tab_hinhanh" role="tabpanel" aria-labelledby="tab_hinhanh">
             
                <div class="row">
                    <div class="col-sm-6" id="pnHinhAnh">
                        <div class="uppy uppy-full-width" id="fhinh_anh">
                            <div class="uppy-dashboard"></div>
                            <div class="uppy-progress"></div>
                        </div>
                    </div>
                    <div class="col-sm-6">
                        <div class="card card-custom card-stretch">
                            <div class="card-header">
                                <div class="card-title">
                                    <h3 class="card-label">Hình ảnh đã tải lên</h3>
                                </div>
                            </div>
                            <div class="card-body" id="listHinh">

                            </div>
                        </div>
                    </div>
                </div>

            </div> 
       
            <div class="tab-pane fade" id="tab_bosung" role="tabpanel" aria-labelledby="tab_bosung">
                <div id="kt_repeater_1">
                    <div class="form-group row" id="kt_repeater_1">
                     
                        <div data-repeater-list="" class="col-lg-12">
                            <div data-repeater-item class="form-group row align-items-center  justify-content-center">
                                <div class="col-md-3">
                                    <label>Tên:</label>
                                    <input type="text" class="form-control" placeholder="Tên tính năng bổ sung" />
                                    <div class="d-md-none mb-2"></div>
                                </div>
                                <div class="col-md-3">
                                    <label>Giá trị:</label>
                                    <input type="text" class="form-control" placeholder="Giá trị tính năng bổ sung" />
                                    <div class="d-md-none mb-2"></div>
                                </div>
                              
                                <div class="col-md-4 pt-6">
                                   
                                    <a href="javascript:;" data-repeater-delete="" class="btn btn-sm font-weight-bolder btn-light-danger mt-2">
                                        <i class="la la-trash-o"></i> Xóa
                                    </a>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="form-group row  justify-content-end">
                        <div class="col-lg-2  text-right">
                            <a href="javascript:;" data-repeater-create="" class="btn btn-sm font-weight-bolder btn-light-primary">
                                <i class="la la-plus"></i> Thêm
                            </a>
                        </div>
                        <div class="col-lg-4">
                           
                        </div>
                    </div>
                </div>
            </div>
            </div>
    </div>
</div>
@section ScriptsFile{
    <script src="~/Scripts/ckeditor-document.bundle.js"></script>
    <script src="~/Scripts/uppy.bundle.js"></script>
    <script src="~/Scripts/parsley.min.js"></script>
}
@section CustomScripts{
    <script type="text/javascript">
        var hinhdaidien = '',hinhdaup = 0;
        $('body').addClass('subheader-fixed');
   
        $(function () {

            $('body').addClass('subheader-fixed');
            $("#txt-dientich").dxNumberBox({
                showSpinButtons: true,
                showClearButton: true,
                format: "###,### ㎡",
                min:5
            });
            $("#txt-lat").dxNumberBox({
                showClearButton: true, value: null
            });
            $("#txt-lng").dxNumberBox({
                showClearButton: true, value: null
            });
            $("#txt-sophongngu").dxSelectBox({
                items: @Html.Raw(RealEstate.Libs.ThongTin.GetSoPhongNgu()),
                placeholder: 'Chọn số phòng ngủ..',
                showClearButton: true,
                searchEnabled: true,
              
                valueExpr: "phong_ngu",
                displayExpr: "phong_ngu",
            });
            $("#txt-sowc").dxSelectBox({
                items: @Html.Raw(RealEstate.Libs.ThongTin.GetSoPhongWC()),
                placeholder: 'Chọn số WC..',
                showClearButton: true,
                searchEnabled: true,
            
                valueExpr: "wc",
                displayExpr: "wc",
            });
            $("#txt-giaban").dxTextBox({
                //showSpinButtons: false,
                //showClearButton: true,
                //format: "",  min: 0,
            });
            $("#txt-giabanusd").dxTextBox({
                //showSpinButtons: false,
                //showClearButton: true,
                //format: "###,###.##", step: 10,
                //min:0,
            });
            $("#txt-giathue").dxTextBox({
                //showSpinButtons: false,
                //showClearButton: true,
                //format: "###,###.##",
                //min: 0,
            });
            $("#txt-giathueusd").dxTextBox({
                //showSpinButtons: false,
                //showClearButton: true,
                //format: "###,###.##",
                //step: 10, min: 0,

            });
            setDanhMuc('select-duan',@Html.Raw(RealEstate.Libs.ThongTin.GetDanhMucString("du-an")), true, 'Dự án');
            setDanhMuc('select-chudautu',@Html.Raw(RealEstate.Libs.ThongTin.GetDanhMucString("chu-dau-tu")), true, 'Chủ đầu tư');
            setDanhMuc('select-huongcua',@Html.Raw(RealEstate.Libs.ThongTin.GetDanhMucString("huong")), false, 'Hướng cửa');
            setDanhMuc('select-tinhtrangcanho',@Html.Raw(RealEstate.Libs.ThongTin.GetDanhMucString("trang-thai")), true, 'Tình trạng');
            setDanhMuc('select-loaicanho',@Html.Raw(RealEstate.Libs.ThongTin.GetDanhMucString("loai")), true, 'Loại căn hộ');
            setDanhMuc('select-vitri',@Html.Raw(RealEstate.Libs.ThongTin.GetDanhMucString("vi-tri")), true, 'Vị trí');
            setDanhMuc('select-views',@Html.Raw(RealEstate.Libs.ThongTin.GetDanhMucString("views")), true, 'Views');
            setDanhMuc('select-loaibangiao',@Html.Raw(RealEstate.Libs.ThongTin.GetDanhMucString("loai-ban-giao")), true, 'Loại bàn giao');
            var dataLoaiKD =@Html.Raw(RealEstate.Libs.ThongTin.GetDanhMucString("loai-kinh-doanh"));
         
            $('#select-loaikinhdoanh').dxTagBox({
                dataSource: dataLoaiKD,
                valueExpr: 'term_taxonomy_id',
                displayExpr: 'name',
                placeholder: "Chọn loại kinh doanh...",
                showClearButton: false,
                searchEnabled: true,
            }).dxValidator({ validationRules: [{ type: "required", message: "Bạn cần chọn loại kinh doanh!" }] })
            DecoupledEditor
                .create(document.querySelector('#txt_noidung'), {
                    placeholder: 'Nhập nội dung đăng tin'
                })
                .then(editor => {
                    const toolbarContainer = document.querySelector('#txt_noidung-toolbar');
                    toolbarContainer.appendChild(editor.ui.view.toolbar.element);
                })
                .catch(error => {
                    console.error(error);
                });
          
            $('#btn-save').click(function () {
                Save(1);


            });
            $('#btn-save-1').click(function () {
                Save(1);
            });
            loadFile();
            $('#kt_repeater_1').repeater({
                initEmpty: false,

                defaultValues: {
                    'text-input': 'foo'
                },

                show: function () {
                    $(this).slideDown();
                },

                hide: function (deleteElement) {

                    Swal.fire({
                        title: "Cảnh báo?",
                        html: '<b class="text-danger">Bạn có chắc xóa tính năng này không?</b><br />Dữ liệu đã xóa thì không thể khôi phục được!',
                        icon: "warning",
                        showCancelButton: true,
                        confirmButtonText: "Có, xóa ngay!",
                        cancelButtonText: "Hủy!",
                        reverseButtons: true
                    }).then(function (result) {
                        if (result.value) {
                            $(this).slideUp(deleteElement);
                            ShowToast.success('Đã xóa tính năng bổ sung', 3000);
                        } else if (result.dismiss === "cancel") {
                            ShowToast.info('Bạn đã hủy xóa tính năng bổ sung', 3000);

                        }
                    });
                }
            });
        });
        function loadFile() {
            $('#listHinh,#pnHinhAnh').empty();
                $.get('@Url.Action("GetFileImages", "DangTin")', { id: '@imgs_key',post:0 }).done(function (rs) {
                    var check = '';
                    hinhdaup = rs.length;
                    $('#pnHinhAnh').html('<div class="uppy uppy-full-width" id="fhinh_anh"> <div class="uppy-dashboard"></div> <div class="uppy-progress"></div> </div>');
                    if (hinhdaup < Number('@ViewBag.dangtin_hinhtoida')) {
                        const Dashboard = Uppy.Dashboard;
                        var id = '#fhinh_anh';
                        var options = {
                            proudlyDisplayPoweredByUppy: false,
                            target: id,
                            inline: true,
                            replaceTargetContent: true,
                            showProgressDetails: true,
                            allowMultipleUploads: true,
                            note: 'Chỉ chấp nhận hình ảnh tối đa 2MB',
                            height: $(window).height() - 350,
                            browserBackButtonClose: true
                        }
                        var uppyDashboard = Uppy.Core({
                            autoProceed: true,
                            restrictions: {
                                maxFileSize: 2097152,
                                maxNumberOfFiles: Number('@ViewBag.dangtin_hinhtoida') - hinhdaup,
                                minNumberOfFiles: hinhdaup == 0 ? Number('@ViewBag.dangtin_hinhtoithieu') : (hinhdaup < Number('@ViewBag.dangtin_hinhtoithieu') ? Number('@ViewBag.dangtin_hinhtoithieu') - hinhdaup : 1),
                                allowedFileTypes: ['image/*', 'video/*']
                            }
                        });
                        const XHRUpload = Uppy.XHRUpload;
                        uppyDashboard.setMeta({ id: '@imgs_key' });
                        uppyDashboard.use(XHRUpload, {
                            endpoint: '@Url.Action("UploadImages", "DangTin")',
                            formData: true,
                            fieldName: 'files[]'
                        });
                        uppyDashboard.on('complete', function (file) {
                            loadFile();
                        });
                        uppyDashboard.use(Dashboard, options);
                      } else {
                    $('#pnHinhAnh').html('<h3 class="text-warning text-primary text-center pt-10 mt-10">Bạn đã tải lên tối đa @ViewBag.dangtin_hinhtoida hình ảnh</h3>');
                }
                var isCoDaiDien = false;
                    $.each(rs, function (i, v) {
                        if (hinhdaidien == v.fileName) {
                            check = 'checked';
                            isCoDaiDien = true;
                        } else {
                            check = '';
                        }
                        $('#listHinh').append('<div class="d-flex flex-wrap align-items-center mb-10">  <div class="symbol symbol-60 symbol-2by3 flex-shrink-0"> <div class="symbol-label" style="background-image: url(\'' + v.url + '\')"></div> </div>  <div class="d-flex flex-column ml-4 flex-grow-1 mr-2"> <a href="' + v.url + '" target="_blank" class="text-dark-75 font-weight-bold text-hover-primary font-size-lg mb-1">' + v.fileName + '</a> <span class="text-muted font-weight-bold">Size: ' + v.size + '</span> <div class="radio-inline"> <label class="radio radio-solid  pt-3"><input type="radio"  name="check-dd" value="' + v.fileName + '" ' + check + '><span></span> Hình đại diện</label>  </div></div>     <a href="javascript:;" onclick="xoahinhanh(this)" fname="' + v.fileName +'" class="btn btn-sm font-weight-bolder btn-light-danger mt-2"><i class="la la-trash-o"></i>Xóa</a> </div>');
                    });
                    if (!isCoDaiDien)
                        hinhdaidien = '';
                    $("input[name='check-dd']:radio").on("change", function () {
                        hinhdaidien = this.value;
                    });
                });
        }
        function xoahinhanh(file) {
            var filename = $(file).attr('fname');
            Swal.fire({
                title: "Cảnh báo?",
                html: 'Bạn có chắc xóa hình ảnh <b class="text-danger">' + filename + '</b> không?<br />Hình ảnh đã xóa thì không thể khôi phục được!',
                icon: "warning",
                showCancelButton: true,
                confirmButtonText: "Có, xóa ngay!",
                cancelButtonText: "Hủy!",
                reverseButtons: true
            }).then(function (result) {
                if (result.value) {
                    KTApp.blockPage({
                        overlayColor: '#000000',
                        state: 'primary',
                        message: 'Đang xóa...'
                    });
                    $.post('@Url.Action("XoaFileLocal", "DangTin")', { id: '@imgs_key', file: filename }).done(function (rs) {
                        KTApp.unblockPage();
                        if (rs.rs_code == 1) {
                            if (hinhdaidien == filename)
                                hinhdaidien = '';
                            loadFile();
                            ShowToast.success('Xóa file thành công', 3000);
                        } else {
                            Swal.fire("Có lỗi!", rs.rs_text, "error");

                        }
                    }).fail(function () {
                        KTApp.unblockPage();
                        ShowToast.warning('Có lỗi xảy ra', 3000);
                    });
                } else if (result.dismiss === "cancel") {
                    ShowToast.info('Bạn đã hủy xóa hình ảnh', 3000);

                }
            });
        }
        function Save(step) {
            var validate = true;
            var data = {};
            data.TieuDe = $("#txt-title").val();
            data.DuAn = $("#select-duan").dxSelectBox("instance").option('value');
            if (!data.DuAn) {
                validate = false;
                $('#select-duan').dxValidator('instance').validate();
            }
            data.ChuDauTu = $("#select-chudautu").dxSelectBox("instance").option('value');
            if (!data.ChuDauTu) {
                validate = false;
                $('#select-chudautu').dxValidator('instance').validate();
            }
            var loaikd = $("#select-loaikinhdoanh").dxTagBox("instance").option('value');
            if (loaikd) {
                data.LoaiKinhDoanh = loaikd.join(',');
            }
            if (!data.LoaiKinhDoanh) {
                validate = false;
                $('#select-loaikinhdoanh').dxValidator('instance').validate();
            }
            data.DienTich = $('#txt-dientich').dxNumberBox('instance').option('value');
            data.HuongCua = $("#select-huongcua").dxSelectBox("instance").option('value');
            data.SoPN = $('#txt-sophongngu').dxSelectBox('instance').option('value');
            data.SoWC = $('#txt-sowc').dxSelectBox('instance').option('value');
            data.View = $("#select-views").dxSelectBox("instance").option('value');
            data.LoaiBanGiao = $("#select-loaibangiao").dxSelectBox("instance").option('value');
          
            data.TinhTrangCH = $("#select-tinhtrangcanho").dxSelectBox("instance").option('value');
            if (!data.TinhTrangCH) {
                validate = false;
                $('#select-tinhtrangcanho').dxValidator('instance').validate();
            }
            data.LoaiCH = $("#select-loaicanho").dxSelectBox("instance").option('value');
            if (!data.LoaiCH) {
                validate = false;
                $('#select-loaicanho').dxValidator('instance').validate();
            }
            data.Vi_Tri = $("#select-vitri").dxSelectBox("instance").option('value');
            if (!data.Vi_Tri) {
                validate = false;
                $('#select-vitri').dxValidator('instance').validate();
            }
            data.HinhDaiDien = hinhdaidien;
             if (data.HinhDaiDien == null || data.HinhDaiDien.length==0) {
                validate = false;
                ShowToast.warning('Bạn chưa chọn hình đại diện', 3000);
                return;
            }
            if (hinhdaup < Number('@ViewBag.dangtin_hinhtoithieu'))  {
                validate = false;
                ShowToast.warning('Bạn cần tải lên tối thiểu @ViewBag.dangtin_hinhtoithieu hình ảnh', 3000);
                return;
            }
            data.VideoLink = $('#txt-videolink').val();
            if ($('#tien-ban').val() == 'ty') {
                data.giaban_ty = $('#txt-giaban').dxTextBox('instance').option('value');

            } else {
                data.giaban_trieu = $('#txt-giaban').dxTextBox('instance').option('value');
            }
            data.giaban_usd = $('#txt-giabanusd').dxTextBox('instance').option('value');
            if ($('#tien-thue').val() == 'ty') {
                data.giathue_ty = $('#txt-giathue').dxTextBox('instance').option('value');
            } else {
                data.giathue_trieu = $('#txt-giathue').dxTextBox('instance').option('value');
            }
            data.giathue_usd = $('#txt-giathueusd').dxTextBox('instance').option('value');

            data.NoiDung = $("#txt_noidung").html();
            data.DiaChi = { address: $('#txt-diachi').val(), lat: $('#txt-lat').dxNumberBox('instance').option('value'), lng: $('#txt-lng').dxNumberBox('instance').option('value'),zoom:15 };
            if (data.NoiDung.length<100) {
                validate = false;
                $("#txt_noidung").addClass('ck-focused');
            }
            data.__RequestVerificationToken = $('input[name="__RequestVerificationToken"]').val();
            data.imgs_key = "@imgs_key";
            var tn = [];
            var t = '', d = 1;
            $("#kt_repeater_1  input").each(function () {
                var gt = $(this).val();
                if (d % 2 == 0) {
                    if (t.length > 0) {
                        if (gt.length > 0)
                            tn.push({ id: t, value: gt });
                    }
                } else {
                    t = gt;

                }
                d++;
            });
            data.TinhNang = tn;
            if ($('#inputform').parsley().validate() && validate) {
                KTApp.blockPage({
                    overlayColor: '#000000',
                    state: 'primary',
                    message: 'Processing...'
                });
                $.post('@Url.Action("CreateSubmit", "DangTin")', data).done(function (rs) {
                    KTApp.unblockPage();
                    if (rs.rs_code >0) {
                        ShowToast.success('Đăng tin mới thành công', 3000);
                        if (step == 1) {
                            window.location.href = '@Url.Action("Edit", "DangTin")?id=' + rs.rs_code;
                        } else
                            if (step == 2) {
                                window.location.href = '@Url.Action("Create", "DangTin")';
                            } else {
                                window.location.href = '@Url.Action("Index", "DangTin")';
                            }
                    } else {
                        Swal.fire("Có lỗi!", rs.rs_text, "error");

                    }
                }).fail(function () {
                    KTApp.unblockPage();
                    ShowToast.warning('Có lỗi xảy ra', 3000);
                });
            } else {
                ShowToast.warning('Bạn cần nhập đủ các trường bắt buộc trước khi lưu', 3000);
            }
        }

    </script>
}