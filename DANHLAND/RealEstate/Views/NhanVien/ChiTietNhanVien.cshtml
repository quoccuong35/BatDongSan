@using RealEstate.Entity 
@{
    ViewBag.Title = "ChiTietCanHo";
    Layout = "~/Views/Shared/_Layout.cshtml";
}
@{
    decimal? id = Model.ID;
    var NhomNguoiDung = (List<dl_nhom_nguoi_dung>)ViewBag.NhomNguoiDung;
    List<dl_nguoidung_phanquyen_nhomnguoidung> NDPhanQuyen = new List<dl_nguoidung_phanquyen_nhomnguoidung>();
    if (id > 0)
    {
         NDPhanQuyen = (List<dl_nguoidung_phanquyen_nhomnguoidung>)ViewBag.NguoiDungPQ;
    }
}
@section CSSFileTop{
    <link href="~/Content/css/uppy.bundle.css" rel="stylesheet" />
}
@section Header{
    <div class="d-flex align-items-center flex-wrap mr-1">
        <button class="btn btn-icon mr-4" id="kt_aside_toggle">
            <span class="svg-icon svg-icon-xl">
                <svg xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" width="24px" height="24px" viewBox="0 0 24 24" version="1.1">
                    <g stroke="none" stroke-width="1" fill="none" fill-rule="evenodd">
                        <rect x="0" y="0" width="24" height="24" />
                        <path d="M2 11.5C2 12.3284 2.67157 13 3.5 13H20.5C21.3284 13 22 12.3284 22 11.5V11.5C22 10.6716 21.3284 10 20.5 10H3.5C2.67157 10 2 10.6716 2 11.5V11.5Z" fill="black" />
                        <path opacity="0.5" fill-rule="evenodd" clip-rule="evenodd" d="M9.5 20C8.67157 20 8 19.3284 8 18.5C8 17.6716 8.67157 17 9.5 17H20.5C21.3284 17 22 17.6716 22 18.5C22 19.3284 21.3284 20 20.5 20H9.5ZM15.5 6C14.6716 6 14 5.32843 14 4.5C14 3.67157 14.6716 3 15.5 3H20.5C21.3284 3 22 3.67157 22 4.5C22 5.32843 21.3284 6 20.5 6H15.5Z" fill="black" />
                    </g>
                </svg>
            </span>
        </button>
        <div class="d-flex align-items-baseline flex-wrap mr-5">
            @{
                if (Model.ID != null && Model.ID > 0)
                {
                    <h5 class="text-dark font-weight-bold my-1 mr-5">
                        #@Model.ID
                    </h5>
                }
            }
            <ul class="breadcrumb breadcrumb-transparent breadcrumb-dot font-weight-bold p-0 my-2 ">
                <li class="breadcrumb-item text-muted">
                    <a href="" class="text-muted">@Resources.App.TaiKhoan</a>
                </li>
                <li class="breadcrumb-item text-muted">
                    @{
                        if (Model.ID != null && Model.ID > 0)
                        {
                            <a href="" class="text-muted">  @Resources.App.TaiKhoanSua</a>
                        }
                        else
                        {
                            <a href="" class="text-muted">  @Resources.App.TaiKhoanThem</a>
                        }
                    }
                </li>
            </ul>
        </div>
    </div>
    <div class="d-flex align-items-center">
        <a href="@Url.Action("Index","NhanVien")" class="btn btn-default font-weight-bold  px-2 font-size-base  mr-2"> <i class="icon-1x text-dark-40 ki flaticon-reply"></i> @Resources.App.QuayLai</a>
        @if (User.IsInRole("0=0") || User.IsInRole("51=1") || User.IsInRole("52=1"))
        {
            <div class="btn-group ml-2">
                <button type="button" class="btn btn-primary font-weight-bold btn-sm px-2 font-size-base" id="btn-save" onclick="CapNhat()">
                    <i class="icon-1x text-dark-40 ki ki-solid-plus"></i>
                    @Resources.App.CapNhat
                </button>
            </div>
        }

    </div>
}
<div class="card card-custom my-5" >
    <div class="card-toolbar">
        <h3 class="nav-text">Thông tin tài khoản</h3>
    </div>
    <div class="card-body">
        <form id="inputform" class="form" data-parsley-validate>
            <div class="form-group row">
                <div class="col-lg-6 ">
                    <label class="form-label">Tài khoản <b class="text-danger">*</b><span class="text-danger text-cost" id="text-taikhoan"></span></label>
                    <input type="text" id="txt-taikhoan" class="form-control" placeholder="Nhập tài khoản" required value="@Model.user_login">
                </div>
                <div class="col-lg-6 ">
                    <label class="form-label">Mật khẩu <b class="text-danger">*</b><span class="text-danger text-cost" id="text-matkhau"></span></label>
                    <input type="password" id="txt-matkhau" class="form-control" placeholder="Nhập nhật khẩu">
                </div>
            </div>
            <div class="form-group row">
                <div class="col-lg-6 ">
                    <label class="form-label">Điện thoại <b class="text-danger">*</b><span class="text-danger text-cost" id="text-dienthoai"></span></label>
                    <input type="text" id="txt-dienthoai" class="form-control" placeholder="Nhập số điện thoại" required value="@Model.user_activation_key">
                </div>
                <div class="col-lg-6 ">
                    <label class="form-label">Email <b class="text-danger">*</b><span class="text-danger text-cost" id="text-email"></span></label>
                    <input type="text" id="txt-email" class="form-control" placeholder="Nhập email" required value="@Model.user_email">
                </div>
            </div>
            <div class="form-group row">
                <div class="col-lg-12">
                    <label class="form-label">Tình trạng<b class="text-danger">*</b></label>
                    <div id="select-tinhtrang">
                    </div>
                </div>
            </div>
        </form>
    </div>
</div>
<div class="card card-custom">
    <div class="card-toolbar">
        <h3 class="nav-text">Vai trò tài khoản</h3>
    </div>
    <div class="card-body">
        <div class="row">
            <div class="checkbox-inline">
                @{
                    foreach (dl_nhom_nguoi_dung item in NhomNguoiDung)
                    {
                        if (id > 0)
                        {
                            var check = NDPhanQuyen.Where(it => it.id_nhom_nguoi_dung == item.id_nhom_nguoi_dung).ToList();
                            if (check.Count > 0)
                            {
                                <label class="checkbox">
                                    <input type="checkbox" name="@item.id_nhom_nguoi_dung" id="@item.id_nhom_nguoi_dung" checked>
                                    <span></span>@item.ten_nhom_nguoi_dung
                                </label>
                            }
                            else
                            {
                                <label class="checkbox">
                                    <input type="checkbox" name="@item.id_nhom_nguoi_dung" id="@item.id_nhom_nguoi_dung">
                                    <span></span>@item.ten_nhom_nguoi_dung
                                </label>
                            }
                        }
                        else
                        {
                            <label class="checkbox">
                                <input type="checkbox" name="@item.id_nhom_nguoi_dung" id="@item.id_nhom_nguoi_dung">
                                <span></span>@item.ten_nhom_nguoi_dung
                            </label>
                        }

                    }
                }
            </div>
        </div>
    </div>
</div>
@section ScriptsFile{
    <script src="~/Scripts/ckeditor-document.bundle.js"></script>
    <script src="~/Scripts/uppy.bundle.js"></script>
    <script src="~/Scripts/parsley.min.js"></script>
}
@section CustomScripts{
    <script type="text/javascript">
        $(function () {
            $("#select-tinhtrang").dxSelectBox({
                items: @Html.Raw(RealEstate.Libs.ThongTin.GetTinhTrangNguoiDung()),
                placeholder: 'Chọn tình trạng..',
                showClearButton: true,
                searchEnabled: true,
                valueExpr: "id_nguoidung_tinhtrang",
                displayExpr: "ten_nguoidung_tinhtrang",
                value:Number('@Model.user_status') > 0 ? Number('@Model.user_status') : null,
            }).dxValidator({ validationRules: [{ type: "required", message: "Tình trạng không thể để trống!" }] });
        });
        function CapNhat() {
            let data = {};
            let validate = true;
           
            let nhomnguoidung = [];
            var checkNguoiDung = $("input[type=checkbox]");
            checkNguoiDung.each(function () {
                if ($(this).is(":checked")) {
                    nhomnguoidung.push(this.id);
                }
            })
            data.user_login = $("#txt-taikhoan").val();
            data.user_pass = $("#txt-matkhau").val();
            data.user_email = $("#txt-email").val();
            data.user_activation_key = $("#txt-dienthoai").val();
            data.user_status = $("#select-tinhtrang").dxSelectBox("instance").option('value');
            if (!data.user_status) {
                validate = false;
                $('#select-tinhtrang').dxValidator('instance').validate();
            }
            if (nhomnguoidung.length == 0) {
                ShowToast.warning('Chưa chọn nhóm người dùng', 3000);
                return;
            }
            data.NhomNguoiDung = nhomnguoidung;
            data.__RequestVerificationToken = $('input[name="__RequestVerificationToken"]').val();
            if ($('#inputform').parsley().validate() && validate) {
                KTApp.blockPage({
                    overlayColor: '#000000',
                    state: 'primary',
                    message: 'Processing...'
                });
                if ("@id" > 0) {
                    data.id = "@id";
                    $.post("@Url.Action("EditNhanVien", "NhanVien")", data).done(function (rs) {
                        if (rs.rs_code == 1) {
                            KTApp.unblockPage();
                            ShowToast.success('Thành công', 3000);
                            window.location.href = '@Url.Action("ChiTietNhanVien", "NhanVien")?id=' + "@id";
                        }
                        else {
                            KTApp.unblockPage();
                            ShowToast.warning('Lỗi ' + rs.rs_text, 3000);
                        }
                    }).fail(function () {
                        KTApp.unblockPage();
                        ShowToast.warning('Có lỗi xảy ra', 3000);
                    })
                }
                else {
                    $.post("@Url.Action("AddNhanVien","NhanVien")", data).done(function (rs) {
                        if (rs.rs_code == 1) {
                            KTApp.unblockPage();
                            ShowToast.success('Thành công', 3000);
                            window.location.href = '@Url.Action("ChiTietNhanVien", "NhanVien")';
                           
                        }
                        else {
                            KTApp.unblockPage();
                            ShowToast.warning('Lỗi' +rs.rs_text, 3000);
                        }
                    }).fail(function () {
                        KTApp.unblockPage();
                        ShowToast.warning('Có lỗi xảy ra', 3000);
                    })
                }
            }
        }
    </script>
}