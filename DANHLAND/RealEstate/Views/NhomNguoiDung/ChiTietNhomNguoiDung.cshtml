@using RealEstate.Entity    ;
@{
    ViewBag.Title = "ChiTietCanHo";
    Layout = "~/Views/Shared/_Layout.cshtml";
}
@{
    decimal? id = Model.id_nhom_nguoi_dung;
    List<v_phanquyen> phanQuyen = (List<v_phanquyen>)ViewBag.phanQuyen;
}
@section CSSFileTop{
    <link href="~/Content/css/uppy.bundle.css" rel="stylesheet" />
}
@section Header{
    <div class="d-flex align-items-center flex-wrap mr-1">
        <button class="btn btn-icon mr-4" id="kt_aside_toggle">
            <span class="svg-icon svg-icon-xl">
                <svg xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" width="24px" height="24px" viewBox="0 0 24 24" version="1.1">
                    <g stroke="none" stroke-width="1" fill="none" fill-rule="evenodd">
                        <rect x="0" y="0" width="24" height="24" />
                        <path d="M2 11.5C2 12.3284 2.67157 13 3.5 13H20.5C21.3284 13 22 12.3284 22 11.5V11.5C22 10.6716 21.3284 10 20.5 10H3.5C2.67157 10 2 10.6716 2 11.5V11.5Z" fill="black" />
                        <path opacity="0.5" fill-rule="evenodd" clip-rule="evenodd" d="M9.5 20C8.67157 20 8 19.3284 8 18.5C8 17.6716 8.67157 17 9.5 17H20.5C21.3284 17 22 17.6716 22 18.5C22 19.3284 21.3284 20 20.5 20H9.5ZM15.5 6C14.6716 6 14 5.32843 14 4.5C14 3.67157 14.6716 3 15.5 3H20.5C21.3284 3 22 3.67157 22 4.5C22 5.32843 21.3284 6 20.5 6H15.5Z" fill="black" />
                    </g>
                </svg>
            </span>
        </button>
        <div class="d-flex align-items-baseline flex-wrap mr-5">
            @{
                if (Model.id_nhom_nguoi_dung != null && Model.id_nhom_nguoi_dung > 0)
                {
                    <h5 class="text-dark font-weight-bold my-1 mr-5">
                        #@Model.id_nhom_nguoi_dung
                    </h5>
                }
            }
            <ul class="breadcrumb breadcrumb-transparent breadcrumb-dot font-weight-bold p-0 my-2 ">
                <li class="breadcrumb-item text-muted">
                    <a href="" class="text-muted">@Resources.App.NhomNguoiDung</a>
                </li>
                <li class="breadcrumb-item text-muted">
                    @{
                        if (Model.id_nhom_nguoi_dung != null && Model.id_nhom_nguoi_dung > 0)
                        {
                            <a href="" class="text-muted">  @Resources.App.NhomNguoiDungSua</a>
                        }
                        else
                        {
                            <a href="" class="text-muted">  @Resources.App.ThemNhomNguoiDung</a>
                        }
                    }
                </li>
            </ul>
        </div>
    </div>
    <div class="d-flex align-items-center">
        <a href="@Url.Action("Index", "NhomNguoiDung")" class="btn btn-default font-weight-bold  px-2 font-size-base  mr-2"> <i class="icon-1x text-dark-40 ki flaticon-reply"></i> @Resources.App.QuayLai</a>
        <div class="btn-group ml-2">
            <button type="button" class="btn btn-primary font-weight-bold btn-sm px-2 font-size-base" id="btn-save" onclick="CapNhat()">
                <i class="icon-1x text-dark-40 ki ki-solid-plus"></i>
                @Resources.App.CapNhat
            </button>
        </div>
    </div>
}
<div class="card card-custom my-5">
    <div class="card-toolbar">
        <h3 class="nav-text">Thông tin nhóm người dùng</h3>
    </div>
    <div class="card-body">
        <form id="inputform" class="form" data-parsley-validate>
            <div class="form-group row">
                <div class="col-lg-12 ">
                    <label class="form-label">Tên nhóm<b class="text-danger">*</b><span class="text-danger text-cost" id="text-tennhom"></span></label>
                    <input type="text" id="txt-tennhom" class="form-control" placeholder="Nhập tài khoản" required value="@Model.ten_nhom_nguoi_dung">
                </div>
            </div>
            <div class="form-group row">
                <div class="col-lg-12 ">
                    <label class="form-label">Ghi chú<span class="text-danger text-cost" id="text-mota"></span></label>
                    <input type="text" id="txt-mota" class="form-control" placeholder="Nhập số điện thoại" value="@Model.mo_ta">
                </div>
            </div>
            <div class="form-group row">
                <div class="col-lg-12">
                    <label class="form-label">Level<b class="text-danger">*</b></label>
                    <div id="select-level">
                    </div>
                </div>
            </div>
        </form>
        <hr />
        <center>
            <table class="table table-bordered">
                <tr>
                    <th scope="col">
                        Mục tiêu
                    </th>
                    <th scope="col">
                        Quyền hạn
                    </th>
                    <th scope="col">
                        Ghi chú
                    </th>
                </tr>
                <tbody>
                    @{
                        string rowspan = "";
                        int i = 0;
                        foreach (v_phanquyen item in phanQuyen)
                        {
                            
                    <tr id="@item.quyen">
                        @if (rowspan == "" || rowspan != item.ten_nhom)
                        {
                            i = phanQuyen.Where(it => it.ten_nhom == item.ten_nhom).Count();
                            <td rowspan="@i" style="font-size:20px">@item.ten_nhom</td>
                        }
                        <td>
                            <label class="checkbox">
                                <input type="checkbox" name="@item.id" id="@item.id" @{ViewContext.Writer.Write(item.@checked);}>
                                <span></span>&nbsp; @item.tenquyen
                            </label>
                        </td>
                        <td>
                            <span></span>&nbsp; @item.GhiChu
                        </td>
                    </tr>
                            rowspan = item.ten_nhom;
                        }
                    }
                </tbody>
            </table>
        </center>
    </div>
</div>

@section ScriptsFile{
    <script src="~/Scripts/ckeditor-document.bundle.js"></script>
    <script src="~/Scripts/uppy.bundle.js"></script>
    <script src="~/Scripts/parsley.min.js"></script>
}
@section CustomScripts{
    <script type="text/javascript">
        $(function () {
            $("#select-level").dxSelectBox({
                items: @Html.Raw(RealEstate.Libs.ThongTin.GetLevelNhomNguoiDung()),
                placeholder: 'Chọn level..',
                showClearButton: true,
                searchEnabled: true,
                valueExpr: "id_level",
                displayExpr: "ten_level",
                value:Number('@Model.id_level') > 0 ? Number('@Model.id_level') : null,
            }).dxValidator({ validationRules: [{ type: "required", message: "Level không được để trống!" }] });;
        });
        function CapNhat() {
            let data = {};
            let validate = true;
            data.ten_nhom_nguoi_dung = $("#txt-tennhom").val();
            data.mo_ta = $("#txt-mota").val();
            data.id_level = $("#select-level").dxSelectBox("instance").option('value');
            if (!data.id_level) {
                validate = false;
                $('#select-level').dxValidator('instance').validate();
            }
            let quyen = [];
            var checkNguoiDung = $("input[type=checkbox]");
            checkNguoiDung.each(function () {
                if ($(this).is(":checked")) {
                    quyen.push(this.id);
                }
            })
            if (quyen.length == 0) {
                ShowToast.warning('Chưa chọn phân quyền cho nhóm người dùng', 3000);
                return;
            }
            data.listQuyen = quyen;
            data.__RequestVerificationToken = $('input[name="__RequestVerificationToken"]').val();
            if ($('#inputform').parsley().validate() && validate) {
                KTApp.blockPage({
                    overlayColor: '#000000',
                    state: 'primary',
                    message: 'Processing...'
                });
                if ("@id" > 0) {
                    data.id_nhom_nguoi_dung = "@id";
                    $.post("@Url.Action("EditNhomNguoiDung", "NhomNguoiDung")", data).done(function (rs) {
                        KTApp.unblockPage();
                        if (rs.rs_code == 1) {
                       
                            ShowToast.success('Thành công', 3000);
                            window.location.href = '@Url.Action("ChiTietNhomNguoiDung", "NhomNguoiDung")?id=' + "@id";
                        }
                        else {
                            KTApp.unblockPage();
                            ShowToast.warning(rs.rs_text, 3000);
                        }
                    }).fail(function () {
                        KTApp.unblockPage();
                        ShowToast.warning('Có lỗi xảy ra', 3000);
                    })
                }
                else {
                    $.post("@Url.Action("AdNhomNguoiDung", "NhomNguoiDung")", data).done(function (rs) {
                        if (rs.rs_code == 1) {
                            KTApp.unblockPage();
                            ShowToast.success('Thành công', 3000);
                            window.location.href = '@Url.Action("ChiTietNhomNguoiDung", "NhomNguoiDung")?id='+rs.rs_text;
                        }
                        else {
                            KTApp.unblockPage();
                            ShowToast.warning(rs.rs_text, 3000);
                        }
                    }).fail(function () {
                        KTApp.unblockPage();
                        ShowToast.warning('Có lỗi xảy ra', 3000);
                    })
                }
            }
        }
    </script>
}