@{
    ViewBag.Title = Resources.App.CanHo_ChiTiet;
    Layout = "~/Views/Shared/_Layout.cshtml";
}
@{
    string Web = ViewBag.Web;
    bool del = false;
    if ((User.IsInRole("0=0")) || User.IsInRole("13=1"))
    {
        del = true;
    }
}
<style>

    .parent {
        position: absolute;
        width: 90%;
        height: 140px;
        white-space: nowrap;
        overflow-x: scroll;
        /*background: #f5f5f5;*/
    }

    /*#myImg:hover {
        opacity: 0.7;
    }*/

    /* The Modal (background) */
    .modal {
        display: none; /* Hidden by default */
        position: fixed; /* Stay in place */
        z-index: 1; /* Sit on top */
        padding-top: 100px; /* Location of the box */
        left: 0;
        top: 0;
        width: 100%; /* Full width */
        height: 100%; /* Full height */
        overflow: auto; /* Enable scroll if needed */
        background-color: rgb(0,0,0); /* Fallback color */
        background-color: rgba(0,0,0,0.9); /* Black w/ opacity */
    }

    /* Modal Content (image) */
    .modal-content {
        margin: auto;
        display: block;
        width: 80%;
        max-width: 700px;
    }

    .child {
        width: 180px;
        height: 80px;
        /*margin-right: 30px;*/
        /*padding: 25px;*/
        box-sizing: border-box;
        background: #3b3b3b;
        display: inline-block;
    }
       /* The Close Button */
    .thoat {
        position: absolute;
        top: 80px;
        right: 100px;
        color: #f1f1f1;
        font-size: 40px;
        font-weight: bold;
        transition: 0.3s;
    }

    .thoat:hover,
    .thoat:focus {
      color: #bbb;
      text-decoration: none;
      cursor: pointer;
    }

</style>
@{
    decimal IDCanHo = Model.CanHo.IDCanHo;
}
@section Header{
    <div class="d-flex align-items-center flex-wrap mr-1">
        <button class="btn btn-icon mr-4" id="kt_aside_toggle">
            <span class="svg-icon svg-icon-xl">
                <svg xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" width="24px" height="24px" viewBox="0 0 24 24" version="1.1">
                    <g stroke="none" stroke-width="1" fill="none" fill-rule="evenodd">
                        <rect x="0" y="0" width="24" height="24" />
                        <path d="M2 11.5C2 12.3284 2.67157 13 3.5 13H20.5C21.3284 13 22 12.3284 22 11.5V11.5C22 10.6716 21.3284 10 20.5 10H3.5C2.67157 10 2 10.6716 2 11.5V11.5Z" fill="black" />
                        <path opacity="0.5" fill-rule="evenodd" clip-rule="evenodd" d="M9.5 20C8.67157 20 8 19.3284 8 18.5C8 17.6716 8.67157 17 9.5 17H20.5C21.3284 17 22 17.6716 22 18.5C22 19.3284 21.3284 20 20.5 20H9.5ZM15.5 6C14.6716 6 14 5.32843 14 4.5C14 3.67157 14.6716 3 15.5 3H20.5C21.3284 3 22 3.67157 22 4.5C22 5.32843 21.3284 6 20.5 6H15.5Z" fill="black" />
                    </g>
                </svg>
            </span>
        </button>
        <div class="d-flex align-items-baseline flex-wrap mr-5">
            <h5 class="text-dark font-weight-bold my-1 mr-5">
                #@Model.CanHo.IDCanHo
            </h5>
            <ul class="breadcrumb breadcrumb-transparent breadcrumb-dot font-weight-bold p-0 my-2 ">
                <li class="breadcrumb-item text-muted">
                    <a href="" class="text-muted">@Resources.App.CanHo</a>
                </li>
                <li class="breadcrumb-item text-muted">
                    <a href="" class="text-muted">  @Resources.App.CanHo_ChiTiet</a>
                </li>
            </ul>
        </div>
    </div>
    <div class="d-flex align-items-center">
        <a href="@Url.Action("Index", "CanHo")" class="btn btn-default font-weight-bold  px-3 font-size-base  mr-2"><i class="icon-1x flaticon-reply"></i>  @Resources.App.QuayLai</a>
        @if (User.IsInRole("0=0") || User.IsInRole("6=1"))
        {
            <a href="@Url.Action("Edit", "CanHo", new { id = Model.CanHo.IDCanHo })" class="btn btn-info font-weight-bold  px-3 font-size-base  mr-2"><i class="icon-1x la la-edit"></i>  @Resources.App.CanHo_ChinhSua</a>
        }
        @if (User.IsInRole("0=0") || User.IsInRole("9=1"))
        {
            <button type="button" class="btn btn-danger font-weight-bold px-3 font-size-base " id="btn-save">
                <i class="icon-1x la la-trash"></i>
                @Resources.App.CanHo_Xoa
            </button>
        }
    </div>
}
<div class="card card-custom">
    <div class="card-body">
        <div class="row">
            <div class="col-md-6">
                <h2>Thông tin chủ nhà</h2>
                <div class="row">
                    <div class="col-md-6">
                        <ul>
                            <li class="my-5"><span style="font-weight: bold">Tên:</span> @Model.CanHo.TenChuNha</li>
                            <li><span style="font-weight: bold">Quốc Tịch:</span> @Model.CanHo.QuocTich</li>
                        </ul>
                    </div>
                    <div class="col-md-6">
                        <ul>
                            <li class="my-5"><span style="font-weight: bold">Ghi chú:</span> @Model.CanHo.GhiChuCanHo</li>
                            <li><span style="font-weight: bold">Liên hệ:</span>@Html.Raw(Model.CanHo.LienHe) </li>
                        </ul>
                    </div>
                </div>
                <h2>Thông tin bất động sản</h2>
                <div class="row">
                    <div class="col-md-6">
                        <ul>
                            <li class="my-5"><span style="font-weight: bold">Dự án:</span> @Model.CanHo.DuAn</li>
                            <li class="my-5"><span style="font-weight: bold">Tháp:</span> @Model.CanHo.Thap</li>
                            <li class="my-5"><span style="font-weight: bold">Tầng:</span> @Model.CanHo.Tang</li>
                            <li class="my-5"><span style="font-weight: bold">Căn:</span> @Model.CanHo.SoCan</li>
                            <li class="my-5"><span style="font-weight: bold">Tình trạng:</span> @Model.CanHo.TinhTrang</li>
                            <li class="my-5"><span style="font-weight: bold">Loại CH:</span> @Model.CanHo.LoaiCanHo</li>
                            <li class="my-5"><span style="font-weight: bold">Số phòng ngủ:</span> @Model.CanHo.PhongNgu</li>
                            <li class="my-5"><span style="font-weight: bold">Số phòng tắm:</span> @Model.CanHo.WC</li>
                        </ul>
                    </div>
                    <div class="col-md-6">
                        <ul>
                            <li class="my-5"><span style="font-weight: bold">Loại bàn giao:</span> @Model.CanHo.LoaiBanGiao</li>
                            <li class="my-5"><span style="font-weight: bold">Diện tích:</span> @Model.CanHo.DienTich</li>
                            <li class="my-5"><span style="font-weight: bold">Hướng cửa:</span> @Model.CanHo.HuongCua</li>
                            <li class="my-5"><span style="font-weight: bold">Hướng ban công:</span> @Model.CanHo.HuongBanCong</li>
                            <li class="my-5"><span style="font-weight: bold">Views:</span> @Model.CanHo.VIEW</li>
                            <li class="my-5"><span style="font-weight: bold">Mật khẩu cửa:</span> @Model.CanHo.MatKhauCua</li>
                        </ul>
                    </div>
                </div>
                <h2>Giá bất động sản</h2>
                <div class="row">
                    <div class="col-md-6">
                        <ul>
                            <li class="my-5"><span style="font-weight: bold">Giá hợp đồng:</span> @Model.CanHo.GiaHopDong</li>
                            <li class="my-5"><span style="font-weight: bold">Giá bán:</span> @Model.CanHo.GiaChaoBan</li>
                            <li class="my-5"><span style="font-weight: bold">Giá chốt bán:</span> @Model.CanHo.GiaChotBan</li>
                        </ul>
                    </div>
                    <div class="col-md-6">
                        <ul>
                            <li class="my-5"><span style="font-weight: bold">Giá ký gửi:</span> @Model.CanHo.GiaChuNhaGui</li>
                            <li class="my-5"><span style="font-weight: bold">Giá thuê:</span> @Model.CanHo.GiaThueNet</li>
                        </ul>
                    </div>
                </div>
                <span style="font-weight: bold" class="my-5">Ngày tạo:</span> @Model.CanHo.NgayTao<br /><br />
                <span style="font-weight: bold" class="my-5">Ngày cập nhật:</span> @Model.CanHo.NgaySua <br /> <br />
                <h2>Ghi chú</h2>
                <div class="row">
                    <div class="col-md-12">
                        <div id="list_ghichu"></div>
                    </div>
                    <div class="col-md-12">
                        <div class="row">
                            <div class="col-md-8">
                                <div class="form-group">
                                    <textarea id="txt-ghichusale" class="form-control" rows="4" placeholder="Nhập nội dung"></textarea>
                                </div>
                            </div>
                            @if ((User.IsInRole("0=0")) || User.IsInRole("12=1"))
                             {
                                <div class="col-md-4">
                                    <select class="form-control selectpicker my-2" id="select-loaighichu">
                                        <option value="1">Admin</option>
                                        <option value="2">Manager</option>
                                        <option value="3" selected>Sale</option>
                                    </select>
                                    <button type="button" class="btn btn-primary" id="btn-save" onclick="AddGhiChuCanHo()">
                                        <i class="icon-1x ki ki-solid-plus"></i>
                                        @Resources.App.CapNhat
                                    </button>
                                </div>
                             }
                        </div>
                    </div>
                </div>
            </div>
            <div class="col-md-6">
                <div class="row my-5">
                    <img id="img" src="@Model.HinhDaiDien" style="width:600px;height:300px">
                </div>

                @{
                    if (Model.Images.Count > 1)
                    {
                        <div class="row my-5">
                            <div class="col-md-4">
                                <h3>Ảnh thực tế</h3>
                            </div>
                            <div class="col-md-8">
                                <a class="btn btn-success btn-sm" href="@ViewBag.UrlImage" target="_blank"><i class="flaticon2-open-box"></i> Open Gallery</a>
                                <button class="btn btn-warning btn-sm" onclick="CopyUrl(this)" data-url="@ViewBag.UrlImage" value="@Web@ViewBag.UrlImage"> <i class="flaticon-attachment"> Copy Link Gallery</i></button>
                            </div>
                        </div>
                        <div class="row form-group my-5">
                            <div class="parent">
                                @{
                                    int j = 1;
                                    foreach (var item in Model.Images)
                                    {
                                        <img src="@item.Url" class="child" style="width:160px;height:100px" onclick="ShowImage(this)">
                                        j++;
                                    }
                                }
                            </div>
                        </div>
                        <br><br><br><br><br><br><br>
                    }
                }
                <div class="row my-5">
                    <h2>Lịch sử chủ nhà</h2>
                    <div id="list_chunha"></div>
                </div>
                <div class="row my-5">
                    <h2>Lịch sử giá</h2>
                    <div id="list_gianha"></div>
                </div>
            </div>


        </div>
    </div>
</div>
<!-- The Modal -->
<div id="myModal" class="modal">
    <span class="thoat">&times;</span>
    <img class="modal-content" id="img01">
    <div id="caption"></div>
</div>
@section CustomScripts{
    <script type="text/javascript">
        var modal = document.getElementById("myModal");
        var modalImg = document.getElementById("img01");
        var isMobile =false;
        $(function () {
            var json =  @Html.Raw(Json.Encode(@Model.GhiChu));
            var dataGhiChu = JSON.parse(JSON.stringify(json));
            isMobile = /iPhone|iPad|iPod|Android/i.test(navigator.userAgent);
            LoadGhiChu(dataGhiChu)
            var json = @Html.Raw(Json.Encode(@Model.LichSuChuNha));
            LoadChuNha(JSON.parse(JSON.stringify(json)));
             var json = @Html.Raw(Json.Encode(@Model.LichSuGia));
            LoadLichSuGia(JSON.parse(JSON.stringify(json)));
        });
        function LoadGhiChu(dataGhiChu) {
            $("#list_ghichu").dxDataGrid({
                dataSource: dataGhiChu,
                showBorders: true,
                paging: {
                    pageSize: 10
                },
                onBeforeSend: function (method, ajaxOptions) {
                    ajaxOptions.xhrFields = { withCredentials: true };
                },
                pager: {
                    showPageSizeSelector: true,
                    allowedPageSizes: [5, 10, 20],
                    showInfo: true
                },
                filterRow: { visible: true },
                columnHidingEnabled: isMobile,
                keyExpr: "id_ghichu",
                columns: [
                    {
                        dataField: "id_ghichu",
                        caption: "#",
                        width: 40
                    },
                    {
                        dataField: "noidung",
                        caption: "Ghi chú"
                    },
                    {

                        dataField: "TenLoai",
                        caption: "Loại",
                        dataType: 'datetime',
                        width: 80,
                    },
                    {
                        width: 40,
                        caption: "Xóa",
                        type: "buttons",
                        visible:"@del" == "True" ? true : false,
                        buttons: [{
                            name: "Xóa",
                            icon: "la la-trash-o",
                            onClick: function (e) {
                                XoaGhiChu(e);
                            }
                        }]

                    }
                ],
            });
        }
        function XoaGhiChu(a) {

            Swal.fire({
                title: "Cảnh báo?",
                html: 'Bạn có chắc xóa ghi chú đang chọn!',
                icon: "warning",
                showCancelButton: true,
                confirmButtonText: "Có, xóa ngay!",
                cancelButtonText: "Hủy!",
                reverseButtons: true
            }).then(function (result) {
                if (result.value) {
                    var data = {};
                    data.id = a.row.key;
                    data.__RequestVerificationToken = $('input[name="__RequestVerificationToken"]').val();
                    $.post("@Url.Action("XoaGhiChuCanHo","CanHo")", data).done(function (rs) {
                        if (rs.rs_code == 1) {

                            ShowToast.success('Xóa thành công', 3000);
                            LoadGhiChu(rs.rs_data)
                        }
                        else {
                            Swal.fire("Có lỗi!","Liên hệ nhà quản trị để được hỗ trợ", "error");
                        }
                    });
                }
            });
        }
        function AddGhiChuCanHo() {
            var ghiChu = $("#txt-ghichusale").val();
            var loaiGhiChu = $('#select-loaighichu').val();

            if (ghiChu == "" || ghiChu.trim().length == 0) {
                ShowToast.warning('Chưa nhập nội dung cần lưu', 3000);
                return;
            }
            var data = {};
            data.IDCanHo = '@IDCanHo';
            data.__RequestVerificationToken = $('input[name="__RequestVerificationToken"]').val();
            switch (loaiGhiChu)
            {
                case "1":
                    data.GhiChuAdmin = ghiChu ;
                    break;
                case "2":
                    data.GhiChuQuanLy = ghiChu;
                    break;
                case "3":
                    data.GhiChuSales = ghiChu;
                    break;
            }
             $.post('@Url.Action("AddGhiChuCanHo", "CanHo")', data).done(function (rs) {

                    if (rs.rs_code ==1) {
                        ShowToast.success('Thêm ghi chú thành công', 3000);
                        LoadGhiChu(rs.rs_data)
                    } else {
                        Swal.fire("Có lỗi!", rs.rs_text, "error");

                    }
                }).fail(function () {

                    ShowToast.warning('Có lỗi xảy ra', 3000);
                });
        }
    function ShowImage(a) {
        var url = $(a).attr("src");
        modal.style.display = "block";
        modalImg.src = url;
    }
            // Get the <span> element that closes the modal
    var span = document.getElementsByClassName("thoat")[0];

    // When the user clicks on <span> (x), close the modal
    span.onclick = function() { 
      modal.style.display = "none";
    }
    function CopyUrl(a) {
        var copy =  "@Web"+$(a).attr("data-url");
        var input = document.createElement('input');
        input.setAttribute('value', copy);
        document.body.appendChild(input);
        input.select();
        var result = document.execCommand('copy');
        document.body.removeChild(input);
        ShowToast.success('Copy thành công', 1000);
    }
    function LoadChuNha(data) {
        $("#list_chunha").dxDataGrid({
            dataSource: data,
            showBorders: true,
            paging: {
                pageSize: 10
            },
            onBeforeSend: function (method, ajaxOptions) {
                ajaxOptions.xhrFields = { withCredentials: true };
            },
            pager: {
                showPageSizeSelector: true,
                allowedPageSizes: [5, 10, 20],
                showInfo: true
            },
            columnHidingEnabled: isMobile,
            filterRow: { visible: true },
            keyExpr: "IdChuNha",
            columns: [
                {
                    dataField: "IdChuNha",
                    caption: "#",
                    width: 40
                },
                {
                    dataField: "TenChuNha",
                    caption: "Chủ nhà"
                },
                {
                    dataField: "NgayTao",
                    caption: "Cập nhật",

                    width: 120,
                },
                {
                    dataField: "GhiChu",
                    caption: "Ghi chú",
                }
            ],
        });
    }
    function LoadLichSuGia(data) {
        $("#list_gianha").dxDataGrid({
            dataSource: data,
            showBorders: true,
            paging: {
                pageSize: 10
            },
            onBeforeSend: function (method, ajaxOptions) {
                ajaxOptions.xhrFields = { withCredentials: true };
            },
            pager: {
                showPageSizeSelector: true,
                allowedPageSizes: [5, 10, 20],
                showInfo: true
            },
            filterRow: { visible: true },
            columnHidingEnabled: isMobile,
            keyExpr: "Id",
            columns: [
                {
                    dataField: "Id",
                    caption: "#",
                    width: 40
                },
                {
                    dataField: "GiaHopDong",
                    caption: "Giá hợp đồng"
                },
                {
                    dataField: "GiaChuNhaGui",
                    caption: "Giá chủ nhà gửi",
                },
                {
                    dataField: "GiaThue",
                    caption: "Giá thuê",
                },
                {
                    dataField: "GiaChaoBan",
                    caption: "Giá chào bán",
                },
                {
                    dataField: "GiaChotBan",
                    caption: "Giá chốt bán",
                }
            ],
        });
    }
    </script>
}