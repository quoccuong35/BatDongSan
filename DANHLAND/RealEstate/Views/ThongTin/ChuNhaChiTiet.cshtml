@using RealEstate.Libs.Models;
@model clsChuNha
@{
    ViewBag.Title = Resources.App.ChuNha;
    Layout = "~/Views/Shared/_Layout.cshtml";
    long IdChuNha = Model.ChuNha.IdChuNha;
}
@{
    bool bNew = false, bEdit = false;
    if (User.IsInRole("0=0") || User.IsInRole("47=1"))
    {
        bNew = true;
    }
    if (User.IsInRole("0=0") || User.IsInRole("48=1"))
    {
        bEdit = true;
    }

}
@section Header{

    <div class="d-flex align-items-center flex-wrap mr-1">

        <button class="btn btn-icon mr-4" id="kt_aside_toggle">
            <span class="svg-icon svg-icon-xl">

                <svg xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" width="24px" height="24px" viewBox="0 0 24 24" version="1.1">
                    <g stroke="none" stroke-width="1" fill="none" fill-rule="evenodd">
                        <rect x="0" y="0" width="24" height="24" />
                        <path d="M2 11.5C2 12.3284 2.67157 13 3.5 13H20.5C21.3284 13 22 12.3284 22 11.5V11.5C22 10.6716 21.3284 10 20.5 10H3.5C2.67157 10 2 10.6716 2 11.5V11.5Z" fill="black" />
                        <path opacity="0.5" fill-rule="evenodd" clip-rule="evenodd" d="M9.5 20C8.67157 20 8 19.3284 8 18.5C8 17.6716 8.67157 17 9.5 17H20.5C21.3284 17 22 17.6716 22 18.5C22 19.3284 21.3284 20 20.5 20H9.5ZM15.5 6C14.6716 6 14 5.32843 14 4.5C14 3.67157 14.6716 3 15.5 3H20.5C21.3284 3 22 3.67157 22 4.5C22 5.32843 21.3284 6 20.5 6H15.5Z" fill="black" />
                    </g>
                </svg>

            </span>
        </button>

        <div class="d-flex align-items-baseline flex-wrap mr-5">

            <h5 class="text-dark font-weight-bold my-1 mr-5">
                @Resources.App.ChuNha

            </h5>
            <ul class="breadcrumb breadcrumb-transparent breadcrumb-dot font-weight-bold p-0 my-2 ">
                @{
                    if (Model.ChuNha.IdChuNha > 0)
                    {
                        <li class="breadcrumb-item text-muted">
                            <a href="" class="text-muted">@Resources.App.ChinhSuaTinDang</a>
                        </li>
                    }
                    else
                    {
                        <li class="breadcrumb-item text-muted">
                            <a href="" class="text-muted">@Resources.App.ThemMoi</a>
                        </li>
                    }
                }
            </ul>
        </div>
    </div>

    <div class="d-flex align-items-center">
        <a href="@Url.Action("ChuNha","ThongTin")" class="btn btn-default font-weight-bold  px-2 font-size-base  mr-2"> <i class="icon-1x text-dark-40 ki flaticon-reply"></i> @Resources.App.QuayLai</a>
        <div class="btn-group ml-2">
            @if (User.IsInRole("0=0") || User.IsInRole("47=1") || User.IsInRole("48=1"))
            {
                <button type="button" class="btn btn-primary font-weight-bold px-2 font-size-base" id="btn-save">
                    <i class="icon-1x text-dark-40 ki ki-solid-plus"></i>
                    @Resources.App.CapNhat
                </button>
            }
        </div>
    </div>
}
<div class="card card-custom">
    <div class="card-body">
        <form id="inputform" class="form" data-parsley-validate>
            <div class="row">
                <label class="form-label">Tên chủ nhà<b class="text-danger">*</b></label>
                <input type="text" class="form-control form-control-solid" id="txt-tenchunha" placeholder="Tên chủ nhà" required name="txt_title" value="@Model.ChuNha.TenChuNha">
            </div>
            <div class="row">
                <label class="form-label">Quốc tịch</label>
                <input type="text" class="form-control" id="txt-quoctich" placeholder="" value="@Model.ChuNha.QuocTich">
            </div>
            <div class="row">
                <label class="form-label">Ghi chú</label>
                <input type="text" class="form-control" id="txt-ghichu" placeholder="" value="@Model.ChuNha.GhiChu">
            </div>
            <br />
            <hr />
            <h2>Liên hệ <b class="text-danger">*</b></h2>
            <div id="kt_repeater_1">
                <div class="form-group row" id="kt_repeater_1">
                    <div data-repeater-list="" class="col-lg-12" id="chitietchunha">
                        @{
                            if (Model.ChuNhaThongTin.Count > 0)
                            {
                                foreach (var item in Model.ChuNhaThongTin)
                                {
                                    <div data-repeater-item class="form-group row align-items-center  justify-content-center">
                                        <div class="col-md-3">
                                            <label>Tên:</label>
                                            <input type="text" class="form-control" placeholder="Tên liên hệ" value="@item.Ten" />
                                            <div class="d-md-none mb-2"></div>
                                        </div>
                                        <div class="col-md-3">
                                            <label>SĐT <b class="text-danger"> *</b></label>
                                            <input type="text" class="form-control" placeholder="Số điện thoại" value="@item.SoDienThoai" id="@item.Id" />
                                            <div class="d-md-none mb-2"></div>
                                        </div>
                                        <div class="col-md-3">
                                            <label>Email</label>
                                            <input type="text" class="form-control" placeholder="Địa chỉ email" value="@item.EMail" />
                                            <div class="d-md-none mb-2"></div>
                                        </div>
                                        <div class="col-md-3 pt-6">
                                            <a href="javascript:;" class="btn btn-sm font-weight-bolder btn-light-danger mt-2" onclick="XoaThongTinChiTietChuNha(@item.Id)">
                                                <i class="la la-trash-o"></i> Xóa
                                            </a>
                                        </div>
                                    </div>
                                }
                            }
                            else
                            {
                                <div data-repeater-item class="form-group row align-items-center  justify-content-center">
                                    <div class="col-md-3">
                                        <label>Tên:</label>
                                        <input type="text" class="form-control" placeholder="Tên liên hệ" />
                                        <div class="d-md-none mb-2"></div>
                                    </div>
                                    <div class="col-md-3">
                                        <label>SĐT <b class="text-danger"> *</b></label>
                                        <input type="text" class="form-control" placeholder="Số điện thoại" />
                                        <div class="d-md-none mb-2"></div>
                                    </div>
                                    <div class="col-md-3">
                                        <label>Email</label>
                                        <input type="text" class="form-control" placeholder="Địa chỉ email" />
                                        <div class="d-md-none mb-2"></div>
                                    </div>
                                    <div class="col-md-3 pt-6">

                                        <a href="javascript:;" data-repeater-delete="" class="btn btn-sm font-weight-bolder btn-light-danger mt-2">
                                            <i class="la la-trash-o"></i> Xóa
                                        </a>
                                    </div>
                                </div>
                            }
                        }
                    </div>
                </div>
                <div class="form-group row  justify-content-end">
                    <div class="col-lg-2  text-right">
                        <a href="javascript:;" class="btn btn-sm font-weight-bolder btn-light-primary" onclick="ThemThongTinChiTiet()">
                            <i class="la la-plus"></i> Thêm
                        </a>
                    </div>
                    <div class="col-lg-4">

                    </div>
                </div>
            </div>
        </form>
    </div>
</div>

@section CustomScripts{
    <script type="text/javascript">
        $(function () {
            $('#kt_repeater_1').repeater({
                initEmpty: false,
                defaultValues: {
                    'text-input': 'foo'
                },
                show: function () {
                    $(this).slideDown();
                },
                hide: function (deleteElement) {
                    Swal.fire({
                        title: "Cảnh báo?",
                        html: '<b class="text-danger">Bạn có chắc xóa tính năng này không?</b><br />Dữ liệu đã xóa thì không thể khôi phục được!',
                        icon: "warning",
                        showCancelButton: true,
                        confirmButtonText: "Có, xóa ngay!",
                        cancelButtonText: "Hủy!",
                        reverseButtons: true
                    }).then(function (result) {
                        if (result.value) {
                            $(this).slideUp(deleteElement);
                            ShowToast.success('Đã xóa tính năng bổ sung', 3000);
                        } else if (result.dismiss === "cancel") {
                            ShowToast.info('Bạn đã hủy xóa tính năng bổ sung', 3000);
                        }
                    });
                }
            });
        });

        function XoaThongTinChiTietChuNha(idChiTiet) {
            var data = {};
            data.__RequestVerificationToken = $('input[name="__RequestVerificationToken"]').val();
            data.Id = idChiTiet;
            Swal.fire({
                title: "Cảnh báo?",
                html: 'Bạn có chắc xóa thông tin đang chọn không?<br />. Đã xóa thì không thể khôi phục được!',
                icon: "warning",
                showCancelButton: true,
                confirmButtonText: "Có, xóa ngay!",
                cancelButtonText: "Hủy!",
                reverseButtons: true
            }).then(function (result) {
                if (result.value) {
                    $.post("@Url.Action("XoaThongTinChuNha","ThongTin")", data).done(function (rs) {
                        if (rs.rs_code = 1) {
                            ShowToast.success('Xóa thành công', 3000);
                            window.location.href = "@Url.Action("ChuNhaChiTiet","ThongTin")?Id=" + "@IdChuNha";
                        }
                        else {
                            ShowToast.warning(rs.rs_text, 3000);
                        }
                    }).fail(function () {
                        ShowToast.warning('Có lỗi xảy ra', 3000);
                    });
                } else if (result.dismiss === "cancel") {
                    ShowToast.info('Bạn đã hủy xóa thông tin', 3000);

                }
            });
        }
        function ThemThongTinChiTiet() {
            $("#chitietchunha").append('<div data-repeater-item class="form-group row align-items-center"><div class="col-md-3"><label>Tên:</label><input type="text" class="form-control" placeholder="Tên liên hệ" value = "" /></div><div class="col-md-3"> <label>SĐT <b class="text-danger"> *</b></label><input type="text" id = "0" class="form-control" placeholder="Số điện thoại" value ="" /></div><div class="col-md-3"> <label>Email</label><input type="text" class="form-control" placeholder="Địa chỉ email" value =""/></div><div class="col-md-2 pt-6"> <a href="javascript:;" data-repeater-delete="" class="btn btn-sm font-weight-bolder btn-light-danger mt-2"><i class="la la-trash-o"></i> Xóa</a></div></div>');
        }
    </script>
    <script type="text/javascript">
        $(function () {
            $("#btn-save").click(function () {
                var check = false;
            var data = {};
            var dataChuNha = {};
            if ($("#txt-tenchunha").val() === null || $("#txt-tenchunha").val().trim() == "")
                check = true;
            dataChuNha.TenChuNha = $("#txt-tenchunha").val();
            dataChuNha.QuocTich = $("#txt-quoctich").val();
            dataChuNha.GhiChu = $("#txt-ghichu").val();
            dataChuNha.IDChuNha = "@IdChuNha";
            data.ChuNha = dataChuNha;
            var tn = [];
            var ten = '', sodt, d = 1,id;
            $("#kt_repeater_1  input").each(function () {
                var gt = $(this).val();
                if (d % 3 == 0) {
                    tn.push({ Ten: ten, SoDienThoai: sodt, EMail: gt,Id:id });
                    ten = sodt = "",id = 0;
                    d = 0;
                }
                else {
                    if (d == 1) {
                        ten = gt;
                    }
                    else if (d == 2) {
                        if (gt.trim().length == 0) {
                            check = true;
                        }
                        else {
                            sodt = gt;
                        }
                        id = Number($(this).attr("id")) > 0 ? $(this).attr("id") : 0;
                    }
                }
                d++;
            });
            if (check) {
                ShowToast.warning('Chưa nhập tên chủ nhà hoặc số điện thoại', 3000);
                return;
            }
            data.ChuNhaThongTin = tn;
            data.__RequestVerificationToken = $('input[name="__RequestVerificationToken"]').val();
            if ("@IdChuNha" ==0) {

                $.post('@Url.Action("AddChuNha", "ThongTin")', data).done(function (rs) {
                    if (rs.rs_code == 1) {
                        window.location.href = "@Url.Action("ChuNhaChiTiet","ThongTin")?Id=" + rs.rs_text;
                        ShowToast.success('Thành công', 3000);

                    } else {
                        Swal.fire("Có lỗi!", rs.rs_text, "error");
                    }
                    }).fail(function () {
                        KTApp.unblockPage();
                        ShowToast.warning('Có lỗi xảy ra', 3000);
                    });
            }
            else {
                 $.post('@Url.Action("EditChuNha", "ThongTin")', data).done(function (rs) {
                     if (rs.rs_code == 1) {
                         window.location.href = "@Url.Action("ChuNhaChiTiet","ThongTin")?Id=" + "@IdChuNha";
                         ShowToast.success('Thành công', 3000);
                    } else {
                        Swal.fire("Có lỗi!", rs.rs_text, "error");
                    }
                    }).fail(function () {
                        KTApp.unblockPage();
                        ShowToast.warning('Có lỗi xảy ra', 3000);
                    });
            }
            });
        })
    </script>
}
